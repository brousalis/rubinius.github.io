<!DOCTYPE html>
<html dir="ltr" lang="ja">
  <head>
    <title>Transformations - Rubinius</title>
  	<meta charset="UTF-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta content='ja' http-equiv='content-language'>
    <meta content='Rubinius is an implementation of the Ruby programming language. The Rubinius bytecode virtual machine is written in C++. The bytecode compiler is written in pure Ruby. The vast majority of the core library is also written in Ruby, with some supporting primitives that interact with the VM directly.' name='description'>
    <link href='/' rel='home'>
    <link href='/' rel='start'>
    <link href='/doc/ja/bytecode-compiler/writer' rel='prev' title='Writer Stage'>
    <link href='/doc/ja/bytecode-compiler/customization'         rel='next' title='Customizing the Pipeline'>
    
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

    <link rel="stylesheet" href="/assets/application-41e9626e04e15a1d2b0393f197784d83.css">
    <link href="/stylesheets/pygments.css" media="screen" rel="stylesheet" />

    <link href="/favicon.ico"                 rel="shortcut icon"    type="image/vnd.microsoft.icon" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="72x72"   />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="114x114" />
  </head>

  <body>
    <nav id="sidebar">
  <div class="sidebar-header">
    <a href="#" class="logo">Rubinius</a>
    <div role="search">
      <input type="text" name="q" placeholder="Search docs">
    </div>
  </div>

  <div class="sidebar-nav">
    <ul>
      <li><a href="/doc/en/what-is-rubinius/">What is Rubinius?</a> </li> 
      <li><a href="/doc/en/getting-started/">Getting Started</a>
        <ul>
          <li><a href="/doc/en/getting-started/requirements/">Requirements</a> </li>
          <li><a href="/doc/en/getting-started/building/">Building</a> </li>
          <li><a href="/doc/en/getting-started/running-rubinius/">Running Rubinius</a> </li>
          <li><a href="/doc/en/getting-started/troubleshooting/">Troubleshooting</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/contributing/">Contributing</a>
        <ul>
          <li><a href="/doc/en/contributing/communication/">Communication</a> </li>
          <li><a href="/doc/en/contributing/style-guide">Style Guide</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/ruby/">Ruby</a>
        <ul>
          <li><a href="/doc/en/ruby/scripts/">Scripts</a> </li>
          <li><a href="/doc/en/ruby/methods/">Methods</a> </li>
          <li><a href="/doc/en/ruby/constants/">Constants</a> </li>
          <li><a href="/doc/en/ruby/classes-and-modules/">Classes &amp; Modules</a> </li>
          <li><a href="/doc/en/ruby/blocks-and-procs/">Blocks &amp; Procs</a> </li>
          <li><a href="/doc/en/ruby/local-variables/">Local Variables</a> </li>
          <li><a href="/doc/en/ruby/instance-variables/">Instance Variables</a> </li>
          <li><a href="/doc/en/ruby/class-variables/">Class Variables</a> </li>
          <li><a href="/doc/en/ruby/global-variables/">Global Variables</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/specs/">Specs</a>
        <ul>
          <li><a href="/doc/en/specs/rubyspec/">RubySpec</a> </li> 
          <li><a href="/doc/en/specs/compiler/">Compiler Specs</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/build-system/">Build System</a> </li>
      <li><a href="/doc/en/bootstrapping/">Bootstrapping</a> </li>
      <li><a href="/doc/en/virtual-machine/">Virtual Machine</a> 
        <ul>
          <li><a href="/doc/en/virtual-machine/instructions/">Instructions</a> </li>
          <li><a href="/doc/en/virtual-machine/custom-dispatch-logic/">Custom Dispatch Logic</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/bytecode-compiler/">Bytecode Compiler</a>
        <ul>
          <li><a href="/doc/en/bytecode-compiler/parser/">Parser Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/ast/">AST</a> </li>
          <li><a href="/doc/en/bytecode-compiler/generator/">Generator Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/encoder/">Encoder Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/packager/">Packager Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/writer/">Writer Stage</a> </li>
          <li>Printers</li>
          <li><a href="/doc/en/bytecode-compiler/transformations/">Transformations</a> </li>
          <li><a href="/doc/en/bytecode-compiler/customization/">Customizing the Pipeline</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/jit/">JIT Compiler</a> </li>
      <li><a href="/doc/en/memory-system/">Memory system</a> 
        <ul>
          <li><a href="/doc/en/memory-system/object-layout/">Object layout</a> </li>
          <li><a href="/doc/en/memory-system/garbage-collector/">Garbage collector</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/systems/">Rubinius Systems</a>
        <ul>
          <li><a href="/doc/en/systems/primitives/">Primitives</a> </li>
          <li><a href="/doc/en/systems/ffi/">FFI</a> </li>
          <li><a href="/doc/en/systems/concurrency/">Concurrency</a> </li>
          <li><a href="/doc/en/systems/io/">IO</a> </li>
          <li><a href="/doc/en/systems/c-api/">C-API</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/tools/">Tools</a>
        <ul>
          <li><a href="/doc/en/tools/debugger/">Debugger</a> </li>
          <li><a href="/doc/en/tools/profiler/">Profiler</a> </li>
          <li><a href="/doc/en/tools/memory-analysis/">Memory Analysis</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/guides/">Guides</a>
        <ul>
          <li><a href="/doc/en/guides/migrating-from-mri-to-rubinius/">Migrating from MRI to Rubinius</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/how-to/">How-To</a>
        <ul>
          <li><a href="/doc/en/how-to/write-a-ticket/">Write a Ticket</a> </li>
          <li><a href="/doc/en/how-to/write-a-ruby-spec/">Write a Ruby Spec</a> </li>
          <li><a href="/doc/en/how-to/fix-a-failing-spec/">Fix a Failing Spec</a> </li>
          <li><a href="/doc/en/how-to/write-benchmarks/">Write Benchmarks</a> </li>
          <li><a href="/doc/en/how-to/write-a-blog-post/">Write a Blog Post</a> </li>
          <li><a href="/doc/en/how-to/write-documentation/">Write Documentation</a> </li>
          <li><a href="/doc/en/how-to/translate-documentation/">Translate Documentation</a> </li>
          <li><a href="/doc/en/how-to/commit-to-github/">Commit to Github</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/appendix-a-glossary/">Appendix A - Glossary</a> </li>
      <li><a href="/doc/en/appendix-b-reading-list/">Appendix B - Reading List</a> </li>
      <li><a href="/doc/en/index-of-terms/">Index of Terms</a> </li>
      <li><a href="/doc/en/frequently-asked-questions/">Frequently Asked Questions</a> </li>
    </ul>
  </div>

  <div class="sidebar-footer">
    <ul>
  
  
  
  <li><a href="/doc/de/bytecode-compiler/transformations.html"
    
    >de</a></li>
  
  
  
  <li><a href="/doc/en/bytecode-compiler/transformations.html"
    
    >en</a></li>
  
  
  
  <li><a href="/doc/es/bytecode-compiler/transformations.html"
    
    >es</a></li>
  
  
  
  <li><a href="/doc/fr/bytecode-compiler/transformations.html"
    
    >fr</a></li>
  
  
  
  <li><a href="/doc/it/bytecode-compiler/transformations.html"
    
    >it</a></li>
  
  
  
  <li><a href="/doc/ja/bytecode-compiler/transformations.html"
    
    class="current"
    
    >ja</a></li>
  
  
  
  <li><a href="/doc/pl/bytecode-compiler/transformations.html"
    
    >pl</a></li>
  
  
  
  <li><a href="/doc/pt-br/bytecode-compiler/transformations.html"
    
    >pt-br</a></li>
  
  
  
  <li><a href="/doc/ru/bytecode-compiler/transformations.html"
    
    >ru</a></li>
  
</ul>

    <div class="social">
      <div class="icons">
        <a href="http://twitter.com/rubinius" class="twitter">@rubinius</a>
        <a href="http://github.com/rubinius" class="github">github</a>
      </div>
      <div class="version">
        <a href="https://github.com/rubinius/rubinius/releases/tag/v2.2.10">v2.2.10</a>
      </div>
    </div>
  </div>
</nav>


<div class="container documentation">
  <h2>Transformations</h2>

  

  

    <p>バイトコードコンパイラはASTを変形するためのシンプルな仕組みを備えていて、
特定の形のASTを認識して置換します。
置換されたASTは元のASTとは違うbytecodeを出力します。
この変形のソースコードは <code>lib/compiler/ast/transforms.rb</code> にあります。</p>

<p>TODO: コンパイラプラグインのアーキテクチャについてドキュメントを書く。</p>

<h3 id="safe-math-compiler-transform">安全な計算のためのコンパイルによる変換(Safe Math Compiler Transform)</h3>

<p>コアライブラリは他のRubyコードと同じブロックで構成されています。
Rubyは動的な言語で、クラスのメソッド定義等をあとから変更することができ(open class)、
実行時の定義が使用されるので(latebinding)、Fixnumなどの基礎となるクラスに
他のクラスが期待するセマンティクスを破壊するような変更を加えることが可能です。
例えば、以下の様な場合を考えます：</p>

<pre><code>class Fixnum
  def +(other)
    (self + other) % 5
  end
end
</code></pre>

<p>固定小数点数の足し算を５を法とする剰余計算(modulo 5)に定義しなおすことは確かに
可能ですが、このようなことをすると、
例えば、Array等が必要な時に正しい長さを計算することができなくなるでしょう。
Rubyの動的さはとても慈しまれている性質ですが、
まさに諸刃の剣となる場合もあります。</p>

<p>標準ライブラリの ‘mathn’ は Fixnum#/ を不適合で安全でない振る舞いに再定義しています。
このライブラリは Fixnum#/ を Fixnum#quo のエイリアスとしていて、
これはデフォルトでは Floatオブジェクトを返します。</p>

<p>このため、特別なコンパイラプラグインを用意して、#/メソッドがあったら
違うメソッド名が出力されるようになっています。
コンパイラは #/ でなく #divide を出力します。
数値のクラス Fixnum, Bignum, Float, Numeric はすべてこのメソッドを定義しています。</p>

<p>この安全な計算のための変換は、コアライブラリのコンパイル中は有効になっています。
通常のユーザコードのコンパイルでは、このプラグインは有効になっていません。
この仕組みにより、コアライブラリを壊したり不便な手順を強制したりせずに、
mathnライブラリをサポートすることができます。</p>


</div>


    <script src="/javascripts/jquery-1.3.2.js"></script>
    <script src="/javascripts/paging_keys.js"></script>
    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
