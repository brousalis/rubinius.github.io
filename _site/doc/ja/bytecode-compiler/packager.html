<!DOCTYPE html>
<html dir="ltr" lang="ja">
  <head>
    <title>Packager Stage - Rubinius</title>
  	<meta charset="UTF-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta content='ja' http-equiv='content-language'>
    <meta content='Rubinius is an implementation of the Ruby programming language. The Rubinius bytecode virtual machine is written in C++. The bytecode compiler is written in pure Ruby. The vast majority of the core library is also written in Ruby, with some supporting primitives that interact with the VM directly.' name='description'>
    <link href='/' rel='home'>
    <link href='/' rel='start'>
    <link href='/doc/ja/bytecode-compiler/encoder' rel='prev' title='Encoder Stage'>
    <link href='/doc/ja/bytecode-compiler/writer'         rel='next' title='Writer Stage'>
    
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

    <link rel="stylesheet" href="/assets/application-41e9626e04e15a1d2b0393f197784d83.css">
    <link href="/stylesheets/pygments.css" media="screen" rel="stylesheet" />

    <link href="/favicon.ico"                 rel="shortcut icon"    type="image/vnd.microsoft.icon" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="72x72"   />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="114x114" />
  </head>

  <body>
    <nav id="sidebar">
  <div class="sidebar-header">
    <a href="#" class="logo">Rubinius</a>
    <div role="search">
      <input type="text" name="q" placeholder="Search docs">
    </div>
  </div>

  <div class="sidebar-nav">
    <ul>
      <li><a href="/doc/en/what-is-rubinius/">What is Rubinius?</a> </li> 
      <li><a href="/doc/en/getting-started/">Getting Started</a>
        <ul>
          <li><a href="/doc/en/getting-started/requirements/">Requirements</a> </li>
          <li><a href="/doc/en/getting-started/building/">Building</a> </li>
          <li><a href="/doc/en/getting-started/running-rubinius/">Running Rubinius</a> </li>
          <li><a href="/doc/en/getting-started/troubleshooting/">Troubleshooting</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/contributing/">Contributing</a>
        <ul>
          <li><a href="/doc/en/contributing/communication/">Communication</a> </li>
          <li><a href="/doc/en/contributing/style-guide">Style Guide</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/ruby/">Ruby</a>
        <ul>
          <li><a href="/doc/en/ruby/scripts/">Scripts</a> </li>
          <li><a href="/doc/en/ruby/methods/">Methods</a> </li>
          <li><a href="/doc/en/ruby/constants/">Constants</a> </li>
          <li><a href="/doc/en/ruby/classes-and-modules/">Classes &amp; Modules</a> </li>
          <li><a href="/doc/en/ruby/blocks-and-procs/">Blocks &amp; Procs</a> </li>
          <li><a href="/doc/en/ruby/local-variables/">Local Variables</a> </li>
          <li><a href="/doc/en/ruby/instance-variables/">Instance Variables</a> </li>
          <li><a href="/doc/en/ruby/class-variables/">Class Variables</a> </li>
          <li><a href="/doc/en/ruby/global-variables/">Global Variables</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/specs/">Specs</a>
        <ul>
          <li><a href="/doc/en/specs/rubyspec/">RubySpec</a> </li> 
          <li><a href="/doc/en/specs/compiler/">Compiler Specs</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/build-system/">Build System</a> </li>
      <li><a href="/doc/en/bootstrapping/">Bootstrapping</a> </li>
      <li><a href="/doc/en/virtual-machine/">Virtual Machine</a> 
        <ul>
          <li><a href="/doc/en/virtual-machine/instructions/">Instructions</a> </li>
          <li><a href="/doc/en/virtual-machine/custom-dispatch-logic/">Custom Dispatch Logic</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/bytecode-compiler/">Bytecode Compiler</a>
        <ul>
          <li><a href="/doc/en/bytecode-compiler/parser/">Parser Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/ast/">AST</a> </li>
          <li><a href="/doc/en/bytecode-compiler/generator/">Generator Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/encoder/">Encoder Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/packager/">Packager Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/writer/">Writer Stage</a> </li>
          <li>Printers</li>
          <li><a href="/doc/en/bytecode-compiler/transformations/">Transformations</a> </li>
          <li><a href="/doc/en/bytecode-compiler/customization/">Customizing the Pipeline</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/jit/">JIT Compiler</a> </li>
      <li><a href="/doc/en/memory-system/">Memory system</a> 
        <ul>
          <li><a href="/doc/en/memory-system/object-layout/">Object layout</a> </li>
          <li><a href="/doc/en/memory-system/garbage-collector/">Garbage collector</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/systems/">Rubinius Systems</a>
        <ul>
          <li><a href="/doc/en/systems/primitives/">Primitives</a> </li>
          <li><a href="/doc/en/systems/ffi/">FFI</a> </li>
          <li><a href="/doc/en/systems/concurrency/">Concurrency</a> </li>
          <li><a href="/doc/en/systems/io/">IO</a> </li>
          <li><a href="/doc/en/systems/c-api/">C-API</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/tools/">Tools</a>
        <ul>
          <li><a href="/doc/en/tools/debugger/">Debugger</a> </li>
          <li><a href="/doc/en/tools/profiler/">Profiler</a> </li>
          <li><a href="/doc/en/tools/memory-analysis/">Memory Analysis</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/guides/">Guides</a>
        <ul>
          <li><a href="/doc/en/guides/migrating-from-mri-to-rubinius/">Migrating from MRI to Rubinius</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/how-to/">How-To</a>
        <ul>
          <li><a href="/doc/en/how-to/write-a-ticket/">Write a Ticket</a> </li>
          <li><a href="/doc/en/how-to/write-a-ruby-spec/">Write a Ruby Spec</a> </li>
          <li><a href="/doc/en/how-to/fix-a-failing-spec/">Fix a Failing Spec</a> </li>
          <li><a href="/doc/en/how-to/write-benchmarks/">Write Benchmarks</a> </li>
          <li><a href="/doc/en/how-to/write-a-blog-post/">Write a Blog Post</a> </li>
          <li><a href="/doc/en/how-to/write-documentation/">Write Documentation</a> </li>
          <li><a href="/doc/en/how-to/translate-documentation/">Translate Documentation</a> </li>
          <li><a href="/doc/en/how-to/commit-to-github/">Commit to Github</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/appendix-a-glossary/">Appendix A - Glossary</a> </li>
      <li><a href="/doc/en/appendix-b-reading-list/">Appendix B - Reading List</a> </li>
      <li><a href="/doc/en/index-of-terms/">Index of Terms</a> </li>
      <li><a href="/doc/en/frequently-asked-questions/">Frequently Asked Questions</a> </li>
    </ul>
  </div>

  <div class="sidebar-footer">
    <ul>
  
  
  
  <li><a href="/doc/de/bytecode-compiler/packager.html"
    
    >de</a></li>
  
  
  
  <li><a href="/doc/en/bytecode-compiler/packager.html"
    
    >en</a></li>
  
  
  
  <li><a href="/doc/es/bytecode-compiler/packager.html"
    
    >es</a></li>
  
  
  
  <li><a href="/doc/fr/bytecode-compiler/packager.html"
    
    >fr</a></li>
  
  
  
  <li><a href="/doc/it/bytecode-compiler/packager.html"
    
    >it</a></li>
  
  
  
  <li><a href="/doc/ja/bytecode-compiler/packager.html"
    
    class="current"
    
    >ja</a></li>
  
  
  
  <li><a href="/doc/pl/bytecode-compiler/packager.html"
    
    >pl</a></li>
  
  
  
  <li><a href="/doc/pt-br/bytecode-compiler/packager.html"
    
    >pt-br</a></li>
  
  
  
  <li><a href="/doc/ru/bytecode-compiler/packager.html"
    
    >ru</a></li>
  
</ul>

    <div class="social">
      <div class="icons">
        <a href="http://twitter.com/rubinius" class="twitter">@rubinius</a>
        <a href="http://github.com/rubinius" class="github">github</a>
      </div>
      <div class="version">
        <a href="https://github.com/rubinius/rubinius/releases/tag/v2.2.10">v2.2.10</a>
      </div>
    </div>
  </div>
</nav>


<div class="container documentation">
  <h2>Packager Stage</h2>

  

  

    <p>EncoderステージでGeneratorオブジェクトが適切にエンコードされたら、
Rubiniusは新しいCompiledCodeオブジェクトを作り、そのたくさんのプロパティを設定して、
バイトコードを CompiledCode オブジェクトとしてパッケージします。</p>

<p>以下のプロパティは全てのCompiledCodeオブジェクトにあります。
<code>executable</code>メソッドを呼ぶと、
RubyのメソッドオブジェクトからCompiledCodeオブジェクトを取り出すことができます。</p>

<ul>
  <li><em>iseq</em>: 生の命令列が入っているTupleオブジェクト</li>
  <li><em>literals</em>: このメソッドで使われている全てのLiteralオブジェクトが入っている
Tupleオブジェクト。
リテラルオブジェクトはRubiniusが内部で文字列の値などに使用していて、
<code>push_literal</code> 命令と <code>set_literal</code> 命令に使われます。</li>
  <li><em>lines</em>: バイトコードで表現される各行について、最初の命令へのポインタが入っている配列。</li>
  <li><em>required_args</em>: メソッドが必要とする引数の数。</li>
  <li><em>total_args</em>: 省略可能な引数を含む、全ての引数の数。
ただし、<code>*args</code>は含みません。</li>
  <li><em>splat</em>: splat引数があれば、その位置。</li>
  <li><em>local_count</em>: ローカル変数の数。引数も含みます。</li>
  <li><em>local_names</em>: 全てのローカル変数名が入っているTuple.
必須な引数、省略可能な引数、splat引数、ブロック引数の順になります。</li>
  <li><em>file</em>: ファイル名。スタックトレースやその他のデバッグ情報に用いられます。</li>
  <li><em>name</em>: メソッド名</li>
  <li><em>primitive</em>: プリミティブの指定があればその名前</li>
  <li>metadata: コンパイルされたメソッドに追加で構造的なメタデータを持たせることができます。
元のジェネレータがブロックのために作られた場合には、
コンパイルされたメソッドは <code>for_block</code> というメタデータを持ち、
その値は <code>true</code> です。</li>
</ul>

<p>Packagerステージでは、全ての子ジェネレータ（メソッドやブロックなど）もまた
CompiledCode化されます。
これらの子CompiedCodeは親CompiledCodeのliterals内に入ります。</p>

<p>Generatorが自身をCompiledCodeとしてパッケージし終えたら、
それを入力値としてWriterステージに移行します。</p>

<h2 id="section">参照されているファイル</h2>

<ul>
  <li><em>kernel/bootstrap/compiled_code.rb</em>: CompiledCodeの基本実装です。
主に、primitivesの配線をしています。</li>
  <li><em>kernel/common/compiled_code.rb</em>: CompiledCodeのもっと堅牢な実装です。
primitiveなメソッドと、Rubyで書かれたメソッドが組み合わされています。</li>
  <li><em>vm/builtin/compiledcode.cpp</em>: CompiledCodeのprimitivesが、C++で実装されています。</li>
  <li><em>lib/compiler/generator.rb</em>: <code>Generator</code>オブジェクトから情報を取り出して
<code>CompiledCode</code>オブジェクトに入れる、<code>package</code>メソッドの実装です。</li>
</ul>

<h2 id="section-1">カスタマイズする</h2>

<p><code>package</code> メソッドは、一般的には、CompiledCodeオブジェクトの変数郡を充填させ
るために設計されていますが、同じインターフェースを使ってPackagerを
他のオブジェクトに情報を入れるために使うこともできます。
しかし、追加のカスタマイズをさらに行わないと、そのままではあまり便利ではないかもしれません。</p>


</div>


    <script src="/javascripts/jquery-1.3.2.js"></script>
    <script src="/javascripts/paging_keys.js"></script>
    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
