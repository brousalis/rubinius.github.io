<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <title>Generator Stage - Rubinius</title>
  	<meta charset="UTF-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta content='en' http-equiv='content-language'>
    <meta content='Rubinius is an implementation of the Ruby programming language. The Rubinius bytecode virtual machine is written in C++. The bytecode compiler is written in pure Ruby. The vast majority of the core library is also written in Ruby, with some supporting primitives that interact with the VM directly.' name='description'>
    <link href='/' rel='home'>
    <link href='/' rel='start'>
    <link href='/doc/en/bytecode-compiler/ast' rel='prev' title='AST'>
    <link href='/doc/en/bytecode-compiler/encoder'         rel='next' title='Encoder Stage'>
    
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

    <link rel="stylesheet" href="/assets/application-41e9626e04e15a1d2b0393f197784d83.css">
    <link href="/stylesheets/pygments.css" media="screen" rel="stylesheet" />

    <link href="/favicon.ico"                 rel="shortcut icon"    type="image/vnd.microsoft.icon" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="72x72"   />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="114x114" />
  </head>

  <body>
    <nav id="sidebar">
  <div class="sidebar-header">
    <a href="#" class="logo">Rubinius</a>
    <div role="search">
      <input type="text" name="q" placeholder="Search docs">
    </div>
  </div>

  <div class="sidebar-nav">
    <ul>
      <li><a href="/doc/en/what-is-rubinius/">What is Rubinius?</a> </li> 
      <li><a href="/doc/en/getting-started/">Getting Started</a>
        <ul>
          <li><a href="/doc/en/getting-started/requirements/">Requirements</a> </li>
          <li><a href="/doc/en/getting-started/building/">Building</a> </li>
          <li><a href="/doc/en/getting-started/running-rubinius/">Running Rubinius</a> </li>
          <li><a href="/doc/en/getting-started/troubleshooting/">Troubleshooting</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/contributing/">Contributing</a>
        <ul>
          <li><a href="/doc/en/contributing/communication/">Communication</a> </li>
          <li><a href="/doc/en/contributing/style-guide">Style Guide</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/ruby/">Ruby</a>
        <ul>
          <li><a href="/doc/en/ruby/scripts/">Scripts</a> </li>
          <li><a href="/doc/en/ruby/methods/">Methods</a> </li>
          <li><a href="/doc/en/ruby/constants/">Constants</a> </li>
          <li><a href="/doc/en/ruby/classes-and-modules/">Classes &amp; Modules</a> </li>
          <li><a href="/doc/en/ruby/blocks-and-procs/">Blocks &amp; Procs</a> </li>
          <li><a href="/doc/en/ruby/local-variables/">Local Variables</a> </li>
          <li><a href="/doc/en/ruby/instance-variables/">Instance Variables</a> </li>
          <li><a href="/doc/en/ruby/class-variables/">Class Variables</a> </li>
          <li><a href="/doc/en/ruby/global-variables/">Global Variables</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/specs/">Specs</a>
        <ul>
          <li><a href="/doc/en/specs/rubyspec/">RubySpec</a> </li> 
          <li><a href="/doc/en/specs/compiler/">Compiler Specs</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/build-system/">Build System</a> </li>
      <li><a href="/doc/en/bootstrapping/">Bootstrapping</a> </li>
      <li><a href="/doc/en/virtual-machine/">Virtual Machine</a> 
        <ul>
          <li><a href="/doc/en/virtual-machine/instructions/">Instructions</a> </li>
          <li><a href="/doc/en/virtual-machine/custom-dispatch-logic/">Custom Dispatch Logic</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/bytecode-compiler/">Bytecode Compiler</a>
        <ul>
          <li><a href="/doc/en/bytecode-compiler/parser/">Parser Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/ast/">AST</a> </li>
          <li><a href="/doc/en/bytecode-compiler/generator/">Generator Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/encoder/">Encoder Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/packager/">Packager Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/writer/">Writer Stage</a> </li>
          <li>Printers</li>
          <li><a href="/doc/en/bytecode-compiler/transformations/">Transformations</a> </li>
          <li><a href="/doc/en/bytecode-compiler/customization/">Customizing the Pipeline</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/jit/">JIT Compiler</a> </li>
      <li><a href="/doc/en/memory-system/">Memory system</a> 
        <ul>
          <li><a href="/doc/en/memory-system/object-layout/">Object layout</a> </li>
          <li><a href="/doc/en/memory-system/garbage-collector/">Garbage collector</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/systems/">Rubinius Systems</a>
        <ul>
          <li><a href="/doc/en/systems/primitives/">Primitives</a> </li>
          <li><a href="/doc/en/systems/ffi/">FFI</a> </li>
          <li><a href="/doc/en/systems/concurrency/">Concurrency</a> </li>
          <li><a href="/doc/en/systems/io/">IO</a> </li>
          <li><a href="/doc/en/systems/c-api/">C-API</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/tools/">Tools</a>
        <ul>
          <li><a href="/doc/en/tools/debugger/">Debugger</a> </li>
          <li><a href="/doc/en/tools/profiler/">Profiler</a> </li>
          <li><a href="/doc/en/tools/memory-analysis/">Memory Analysis</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/guides/">Guides</a>
        <ul>
          <li><a href="/doc/en/guides/migrating-from-mri-to-rubinius/">Migrating from MRI to Rubinius</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/how-to/">How-To</a>
        <ul>
          <li><a href="/doc/en/how-to/write-a-ticket/">Write a Ticket</a> </li>
          <li><a href="/doc/en/how-to/write-a-ruby-spec/">Write a Ruby Spec</a> </li>
          <li><a href="/doc/en/how-to/fix-a-failing-spec/">Fix a Failing Spec</a> </li>
          <li><a href="/doc/en/how-to/write-benchmarks/">Write Benchmarks</a> </li>
          <li><a href="/doc/en/how-to/write-a-blog-post/">Write a Blog Post</a> </li>
          <li><a href="/doc/en/how-to/write-documentation/">Write Documentation</a> </li>
          <li><a href="/doc/en/how-to/translate-documentation/">Translate Documentation</a> </li>
          <li><a href="/doc/en/how-to/commit-to-github/">Commit to Github</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/appendix-a-glossary/">Appendix A - Glossary</a> </li>
      <li><a href="/doc/en/appendix-b-reading-list/">Appendix B - Reading List</a> </li>
      <li><a href="/doc/en/index-of-terms/">Index of Terms</a> </li>
      <li><a href="/doc/en/frequently-asked-questions/">Frequently Asked Questions</a> </li>
    </ul>
  </div>

  <div class="sidebar-footer">
    <ul>
  
  
  
  <li><a href="/doc/de/bytecode-compiler/generator.html"
    
    >de</a></li>
  
  
  
  <li><a href="/doc/en/bytecode-compiler/generator.html"
    
    class="current"
    
    >en</a></li>
  
  
  
  <li><a href="/doc/es/bytecode-compiler/generator.html"
    
    >es</a></li>
  
  
  
  <li><a href="/doc/fr/bytecode-compiler/generator.html"
    
    >fr</a></li>
  
  
  
  <li><a href="/doc/it/bytecode-compiler/generator.html"
    
    >it</a></li>
  
  
  
  <li><a href="/doc/ja/bytecode-compiler/generator.html"
    
    >ja</a></li>
  
  
  
  <li><a href="/doc/pl/bytecode-compiler/generator.html"
    
    >pl</a></li>
  
  
  
  <li><a href="/doc/pt-br/bytecode-compiler/generator.html"
    
    >pt-br</a></li>
  
  
  
  <li><a href="/doc/ru/bytecode-compiler/generator.html"
    
    >ru</a></li>
  
</ul>

    <div class="social">
      <div class="icons">
        <a href="http://twitter.com/rubinius" class="twitter">@rubinius</a>
        <a href="http://github.com/rubinius" class="github">github</a>
      </div>
      <div class="version">
        <a href="https://github.com/rubinius/rubinius/releases/tag/v2.2.10">v2.2.10</a>
      </div>
    </div>
  </div>
</nav>


<div class="container documentation">
  <h2>Generator Stage</h2>

  

  
    <div class="review">
  <p>This topic has missing or partial documentation. Please help us improve it.</p>

  <p>
    See <a href="/doc/en/how-to/write-documentation">How-To - Write Documentation</a>
  </p>
</div>

  

    <p>Once Melbourne has created an AST, it invokes the generator stage,
passing the AST as the input.</p>

<p>The generator stage creates a new instance of <code>Rubinius::Generator</code>, and
asks the root of the AST to generate its bytecode onto the <code>Generator</code>
object.</p>

<p>A <code>Generator</code> provides a pure-Ruby DSL for generating Rubinius bytecode.
At its core, the <code>Generator</code> provides methods that map directly to
<a href="/doc/en/virtual-machine/instructions/">Rubinius Instructions</a>. For instance,
to create an instruction to push a nil onto the stack, you could call
the method <code>push_nil</code> on a <code>Generator</code> instance.</p>

<p>The <code>Generator</code> class also provides a number of convenience methods that
allow you to generate common patterns of bytecodes without going into
the very low-level details of some areas of the Rubinius instruction
set.</p>

<p>For instance, to send a method directly using Rubinius bytecode, you
would need to create a literal representing the name of the method, and
then call <code>send_stack</code> to send the method. In addition, if you wanted to
call a private method, you would first need to create a bytecode
specifically allowing private method invocation. If you wanted to invoke
the method <code>puts</code> with no arguments, allowing private method
invocations, you would:</p>

<pre><code># here, g is a Generator instance
g.allow_private
name = find_literal(:puts)
g.send_stack name, 0
</code></pre>

<p>Using the <code>send</code> helper, you could do this more simply:</p>

<pre><code>g.send :puts, 0, true
</code></pre>

<p>When generating the bytecode for an AST, Rubinius invokes the method
<code>bytecode</code> on each AST node, passing in the current <code>Generator</code>
instance. Hereâ€™s the bytecode method for the <code>if</code> node:</p>

<pre><code>def bytecode(g)
  pos(g)

  done = g.new_label
  else_label = g.new_label

  @condition.bytecode(g)
  g.gif else_label

  @body.bytecode(g)
  g.goto done

  else_label.set!
  @else.bytecode(g)

  done.set!
end
</code></pre>

<p>First, the method calls the method <code>pos</code>, a method on the base <code>Node</code>
class, which calls <code>g.set_line @line</code>. This is used by the VM to provide
debugging information for running code.</p>

<p>Next, the code uses the label helpers in the <code>Generator</code>. Raw Rubinius
bytecode does not have any control structures except for a few goto
instructions (plain <code>goto</code>, <code>goto_if_true</code> and <code>goto_if_false</code>). You can
use the shortened form <code>git</code> for <code>goto_if_true</code> and <code>gif</code> for
<code>goto_if_false</code>. In this case, we create two new labels, one for the end
of the <code>if</code> condition, and one marking the start of the <code>else</code> block.</p>

<p>After creating the two labels, the <code>if</code> node invokes the <code>bytecode</code>
method on its <code>@condition</code> child node, passing along the current
<code>Generator</code> object. This will emit the bytecode for the condition into
the current stream.</p>

<p>That process should leave the value of the condition expression on the
stack, so the <code>if</code> node emits a <code>goto_if_false</code> instruction that will
jump immediately to <code>else_label</code>. It then uses the same pattern we saw
before to ask the <code>@body</code> to emit its bytecode into the current stream,
and then emits an unconditional <code>goto</code> instruction to the end of the
conditional.</p>

<p>Next, we need to mark the location of the <code>else_label</code>. By decoupling the
creation of the label from its use, we can pass it to the <code>goto</code>
instruction before marking its location, which is crucial for many
control structures.</p>

<p>We then ask the <code>@else</code> node to emit its bytecode and mark the location
of the <code>done</code> label.</p>

<p>This process occurs recursively from the root node all the way through
the AST, which results in populating the <code>Generator</code> object with a
bytecode representation of the AST that started from the root.</p>

<p>You will probably find it useful to look at the classes in the
<code>lib/compiler/ast</code> directory, which define all of the AST nodes and
their associated bytecode methods. This is also a good way to see
practical examples of using the <code>Generator</code> API.</p>

<p>Once the <code>Generator</code> has acquired the bytecode representation of the
AST, it invokes the next stage of the compiler, the Encoder stage.</p>

<h2 id="files-referenced">Files Referenced</h2>

<ul>
  <li><em>lib/compiler/generator_methods.rb</em>: A generated file containing Ruby
wrappers around the Rubinius instructions. These methods map directly
onto the <a href="/doc/en/virtual-machine/instructions/">Rubinius Instructions</a></li>
  <li><em>lib/compiler/generator.rb</em>: The definition of the <code>Generator</code> object.
This class mixes in the raw generator methods, and defines a number of
higher level APIs for generating common bytecode patterns.</li>
  <li><em>lib/compiler/ast</em>: The definition of all of the AST nodes created by
the Parser stage of the compiler.</li>
</ul>

<h2 id="customization">Customization</h2>

<p>The easiest way to customize the Generator stage of the compiler process
is by creating higher-level methods in addition to the common ones
provided by the default <code>Generator</code> implementation.</p>

<p>You can also customize which generator class is passed in. To learn
more about customizing individual compiler stages or the compiler
pipeline, please read <a href="/doc/en/bytecode-compiler/customization/">Customizing the Compiler
Pipeline</a>.</p>


</div>


    <script src="/javascripts/jquery-1.3.2.js"></script>
    <script src="/javascripts/paging_keys.js"></script>
    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
