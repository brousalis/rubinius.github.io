<!DOCTYPE html>
<html dir="ltr" lang="ja">
  <head>
    <title>Generator Stage - Rubinius</title>
  	<meta charset="UTF-8">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta content='ja' http-equiv='content-language'>
    <meta content='Rubinius is an implementation of the Ruby programming language. The Rubinius bytecode virtual machine is written in C++. The bytecode compiler is written in pure Ruby. The vast majority of the core library is also written in Ruby, with some supporting primitives that interact with the VM directly.' name='description'>
    <link href='/' rel='home'>
    <link href='/' rel='start'>
    <link href='/doc/ja/bytecode-compiler/ast' rel='prev' title='AST'>
    <link href='/doc/ja/bytecode-compiler/encoder'         rel='next' title='Encoder Stage'>
    
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

    <link href="/stylesheets/application.css" media="screen" rel="stylesheet" />
    <link href="/stylesheets/pygments.css" media="screen" rel="stylesheet" />

    <link href="/favicon.ico"                 rel="shortcut icon"    type="image/vnd.microsoft.icon" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="72x72"   />
    <link href="/images/apple-touch-icon.png" rel="apple-touch-icon" type="image/png" sizes="114x114" />
  </head>

  <body>
    <nav id="sidebar">
  <div class="sidebar-header">
    <a href="#" class="logo">Rubinius</a>
    <div role="search">
      <input type="text" name="q" placeholder="Search docs">
    </div>
  </div>

  <div class="sidebar-nav">
    <ul>
      <li><a href="/doc/en/what-is-rubinius/">What is Rubinius?</a> </li> 
      <li><a href="/doc/en/getting-started/">Getting Started</a>
        <ul>
          <li><a href="/doc/en/getting-started/requirements/">Requirements</a> </li>
          <li><a href="/doc/en/getting-started/building/">Building</a> </li>
          <li><a href="/doc/en/getting-started/running-rubinius/">Running Rubinius</a> </li>
          <li><a href="/doc/en/getting-started/troubleshooting/">Troubleshooting</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/contributing/">Contributing</a>
        <ul>
          <li><a href="/doc/en/contributing/communication/">Communication</a> </li>
          <li><a href="/doc/en/contributing/style-guide">Style Guide</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/ruby/">Ruby</a>
        <ul>
          <li><a href="/doc/en/ruby/scripts/">Scripts</a> </li>
          <li><a href="/doc/en/ruby/methods/">Methods</a> </li>
          <li><a href="/doc/en/ruby/constants/">Constants</a> </li>
          <li><a href="/doc/en/ruby/classes-and-modules/">Classes &amp; Modules</a> </li>
          <li><a href="/doc/en/ruby/blocks-and-procs/">Blocks &amp; Procs</a> </li>
          <li><a href="/doc/en/ruby/local-variables/">Local Variables</a> </li>
          <li><a href="/doc/en/ruby/instance-variables/">Instance Variables</a> </li>
          <li><a href="/doc/en/ruby/class-variables/">Class Variables</a> </li>
          <li><a href="/doc/en/ruby/global-variables/">Global Variables</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/specs/">Specs</a>
        <ul>
          <li><a href="/doc/en/specs/rubyspec/">RubySpec</a> </li> 
          <li><a href="/doc/en/specs/compiler/">Compiler Specs</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/build-system/">Build System</a> </li>
      <li><a href="/doc/en/bootstrapping/">Bootstrapping</a> </li>
      <li><a href="/doc/en/virtual-machine/">Virtual Machine</a> 
        <ul>
          <li><a href="/doc/en/virtual-machine/instructions/">Instructions</a> </li>
          <li><a href="/doc/en/virtual-machine/custom-dispatch-logic/">Custom Dispatch Logic</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/bytecode-compiler/">Bytecode Compiler</a>
        <ul>
          <li><a href="/doc/en/bytecode-compiler/parser/">Parser Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/ast/">AST</a> </li>
          <li><a href="/doc/en/bytecode-compiler/generator/">Generator Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/encoder/">Encoder Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/packager/">Packager Stage</a> </li>
          <li><a href="/doc/en/bytecode-compiler/writer/">Writer Stage</a> </li>
          <li>Printers</li>
          <li><a href="/doc/en/bytecode-compiler/transformations/">Transformations</a> </li>
          <li><a href="/doc/en/bytecode-compiler/customization/">Customizing the Pipeline</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/jit/">JIT Compiler</a> </li>
      <li><a href="/doc/en/memory-system/">Memory system</a> 
        <ul>
          <li><a href="/doc/en/memory-system/object-layout/">Object layout</a> </li>
          <li><a href="/doc/en/memory-system/garbage-collector/">Garbage collector</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/systems/">Rubinius Systems</a>
        <ul>
          <li><a href="/doc/en/systems/primitives/">Primitives</a> </li>
          <li><a href="/doc/en/systems/ffi/">FFI</a> </li>
          <li><a href="/doc/en/systems/concurrency/">Concurrency</a> </li>
          <li><a href="/doc/en/systems/io/">IO</a> </li>
          <li><a href="/doc/en/systems/c-api/">C-API</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/tools/">Tools</a>
        <ul>
          <li><a href="/doc/en/tools/debugger/">Debugger</a> </li>
          <li><a href="/doc/en/tools/profiler/">Profiler</a> </li>
          <li><a href="/doc/en/tools/memory-analysis/">Memory Analysis</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/guides/">Guides</a>
        <ul>
          <li><a href="/doc/en/guides/migrating-from-mri-to-rubinius/">Migrating from MRI to Rubinius</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/how-to/">How-To</a>
        <ul>
          <li><a href="/doc/en/how-to/write-a-ticket/">Write a Ticket</a> </li>
          <li><a href="/doc/en/how-to/write-a-ruby-spec/">Write a Ruby Spec</a> </li>
          <li><a href="/doc/en/how-to/fix-a-failing-spec/">Fix a Failing Spec</a> </li>
          <li><a href="/doc/en/how-to/write-benchmarks/">Write Benchmarks</a> </li>
          <li><a href="/doc/en/how-to/write-a-blog-post/">Write a Blog Post</a> </li>
          <li><a href="/doc/en/how-to/write-documentation/">Write Documentation</a> </li>
          <li><a href="/doc/en/how-to/translate-documentation/">Translate Documentation</a> </li>
          <li><a href="/doc/en/how-to/commit-to-github/">Commit to Github</a> </li>
        </ul>
      </li>
      <li><a href="/doc/en/appendix-a-glossary/">Appendix A - Glossary</a> </li>
      <li><a href="/doc/en/appendix-b-reading-list/">Appendix B - Reading List</a> </li>
      <li><a href="/doc/en/index-of-terms/">Index of Terms</a> </li>
      <li><a href="/doc/en/frequently-asked-questions/">Frequently Asked Questions</a> </li>
    </ul>
  </div>

  <div class="sidebar-footer">
    <ul>
  
  
  
  <li><a href="/doc/de/bytecode-compiler/generator/"
    
    >de</a></li>
  
  
  
  <li><a href="/doc/en/bytecode-compiler/generator/"
    
    >en</a></li>
  
  
  
  <li><a href="/doc/es/bytecode-compiler/generator/"
    
    >es</a></li>
  
  
  
  <li><a href="/doc/fr/bytecode-compiler/generator/"
    
    >fr</a></li>
  
  
  
  <li><a href="/doc/it/bytecode-compiler/generator/"
    
    >it</a></li>
  
  
  
  <li><a href="/doc/ja/bytecode-compiler/generator/"
    
    class="current"
    
    >ja</a></li>
  
  
  
  <li><a href="/doc/pl/bytecode-compiler/generator/"
    
    >pl</a></li>
  
  
  
  <li><a href="/doc/pt-br/bytecode-compiler/generator/"
    
    >pt-br</a></li>
  
  
  
  <li><a href="/doc/ru/bytecode-compiler/generator/"
    
    >ru</a></li>
  
</ul>

    <div class="social">
      <div class="icons">
        <a href="http://twitter.com/rubinius" class="twitter">@rubinius</a>
        <a href="http://github.com/rubinius" class="github">github</a>
      </div>
      <div class="version">
        <a href="https://github.com/rubinius/rubinius/releases/tag/v2.2.10">v2.2.10</a>
      </div>
    </div>
  </div>
</nav>


<div class="container documentation">
  <h2>Generator Stage</h2>

  

  
    <div class="review">
  <p>This topic has missing or partial documentation. Please help us improve it.</p>

  <p>
    See <a href="/doc/ja/how-to/write-documentation">How-To - Write Documentation</a>
  </p>
</div>

  

    <p>MelbourneはASTを作成すると、
それを入力値として次のステージ（Generator）を実行します。</p>

<p>ジェネレータステージでは<code>Rubinius::Generator</code>のインスタンスが作られ、ASTの
ルートにこの <code>Generator</code> オブジェクト上でそのバイトコード表現を生成してもらい
ます。</p>

<p><code>Generator</code>はRubiniusのバイトコードを生成するための純粋にRubyなDSLを提供しま
す。その中心は、<a href="/doc/ja/virtual-machine/instructions/">Rubinius Instructions</a>
に直接マップされるメソッド郡です。例えば、スタックにnilを積む命令は、
<code>Generator</code>インスタンスの<code>push_nil</code>メソッドを呼ぶことで作成できます。</p>

<p><code>Generator</code>クラスには他にも多くの便利なメソッドが定義されていて、
よくあるパターンのバイトコードはRubiniusの命令セットの
特に非常にローレベルな部分を扱わなくてもに生成できるようになっています。</p>

<p>例えば、直接Rubiniusのバイトコードを使ってメソッドを呼ぶには、
まずメソッド名を表すリテラルを作る必要があります。
そして、メソッドを呼ぶために<code>send_stack</code>を呼びます。
さらに、もしプライベートメソッドを実行したい場合は、
先にプライベートメソッドをの実行を特別に許可するためのバイトコードを生成します。</p>

<p>プライベートメソッドの実行を許可した上で<code>puts</code>メソッドを引数無しで呼びたい場合、
以下のように書きます：</p>

<pre><code># ここで、 g は Generator のインスタンス
g.allow_private
name = find_literal(:puts)
g.send_stack name, 0
</code></pre>

<p>これは、<code>send</code>ヘルパーを使うともっと簡単に書くことができます：</p>

<pre><code>g.send :puts, 0, true
</code></pre>

<p>あるASTについてバイトコードを生成する際、
RubiniusはASTの各ノードについて<code>bytecode</code>メソッドを呼びます。
この時、引数として現在の<code>Generator</code>インスタンスを渡します。
これは、<code>if</code>ノードの bytecode メソッドです：</p>

<pre><code>def bytecode(g)
  pos(g)

  done = g.new_label
  else_label = g.new_label

  @condition.bytecode(g)
  g.gif else_label

  @body.bytecode(g)
  g.goto done

  else_label.set!
  @else.bytecode(g)

  done.set!
end
</code></pre>

<p>まず、<code>pos</code>メソッドを呼びます。
これは<code>Node</code>クラスのメソッドで<code>g.set_line @line</code>を実行します。
これは、VMがデバッグ用の情報を実行時に提供するのに使われます。</p>

<p>次に、<code>Generator</code>の<code>label</code>ヘルパーを使っています。
純粋な Rubiniusバイトコードは、
少数のgoto命令(<code>goto</code>、<code>goto_if_true</code>、<code>goto_if_false</code>)を除き、
一切の制御構造を持ちません。
<code>goto_if_true</code>のかわりに<code>git</code>、<code>goto_if_false</code>のかわりに<code>gif</code>、
と短く書くことができます。
ここでは、２つの新しいラベルを作成しています。
１つは<code>if</code>条件の終わり、もう１つは<code>else</code>ブロックの開始地点を示しています。</p>

<p>２つのラベルが作成されると、<code>if</code>ノードがその子ノードである<code>@condition</code>について
現在の<code>Generator</code>オブジェクトを引数として<code>bytecode</code>メソッドを呼びます。
これにより、この条件式のバイトコードが現在のストリームに出力されます。</p>

<p>この処理はこの条件式の値をスタックに残すので、
<code>if</code>ノードは<code>else_label</code>にすぐ飛ぶための<code>goto_if_false</code>命令を出力します。
そして、上で見たのと同じやり方で<code>@body</code>のバイトコードを現在のストリームに出力したら、
条件式の最後に飛ぶための無条件の<code>goto</code>命令を出力します。</p>

<p>次に、<code>else_label</code>の場所をセットする必要があります。
ラベルの作成と使用が分離されているので、
ラベルオブジェクトの場所を指定する前に<code>goto</code>命令に渡すことができます。
この性質は、いろいろな制御構造を作る際に重要になります。</p>

<p>それから、<code>@else</code>ノードのバイトコードを出力し、<code>done</code>ラベルの場所を指定します。</p>

<p>この処理はルートノードから始まり再帰的にAST全体について実行され、
結果として<code>Generator</code>オブジェクトにASTのバイトコード表現が生成されます。</p>

<p><code>lib/compiler/ast</code>ディレクトリ内に全てのASTノードとそのbytecodeメソッドが定義
されているので、参照すると役立つと思います。
<code>Generator API</code> の実用的な例としてもいいと思います。</p>

<p><code>Generator</code>はASTのバイトコード表現を生成し終えたら、次のステージを実行します。
エンコーダステージです。</p>

<h2>参照されているファイル</h2>

<ul>
<li><em>lib/compiler/generator_methods.rb</em>: Rubinius 命令セットのRubyによるラッパー
が生成されています。
これらのメソッドは各命令（<a href="/doc/en/virtual-machine/instructions/">Rubinius Instructions</a>）
に直接マップされています。</li>
<li><em>lib/compiler/generator.rb</em>: <code>Generator</code> オブジェクトの定義です。
このクラスは純粋なジェネレータメソッドに加えて、
よくあるバイトコードのパターンを生成する多数の抽象度の高いAPIを定義しています。</li>
<li><em>lib/compiler/ast</em>: パーサステージで生成される全てのASTノードの定義があります。</li>
</ul>


<h2>カスタマイズする</h2>

<p>ジェネレータステージをカスタマイズする一番簡単な方法は、
<code>Generator</code>にデフォルトで定義されている一般的なものに加えて、
抽象度の高いメソッドをさらに定義することです。</p>

<p>使われるジェネレータクラスを変更することもできます。
コンパイラの各ステージやパイプラインをカスタマイズする方法についてさらに知るには、
<a href="/doc/ja/bytecode-compiler/customization/">コンパイラパイプラインのカスタマイズ</a>
を参照して下さい。</p>


</div>


    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="/javascripts/jquery-1.3.2.js"></script>
    <script src="/javascripts/paging_keys.js"></script>
    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
